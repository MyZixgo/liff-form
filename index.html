<script>
/* ================= CONFIG ================= */
const LIFF_ID = "2008917250-2HZ9qo2C";
const FLOW_URL = "YOUR_FLOW_URL";

/* ================= FL / BT GROUP ================= */
const flGroup1 = ["FL-14","FL-18","FL-19","FL-20","FL-21","FL-22","FL-30"];
const flGroup2 = ["FL-01","FL-02","FL-04","FL-05","FL-06","FL-07","FL-08","FL-09","FL-16","FL-23","FL-24","FL-26","FL-27","FL-15","FL-17"];
const flGroup3 = ["FL-10","FL-11","FL-13","FL-29","FL-32","FL-33","FL-34","FL-35","FL-36","FL-37","FL-38"];

const btGroup1 = ["R-15686","R-15687","R-15688","R-15689","R-15690","R-15691","R-15692","R-15693"];
const btGroup2 = ["R-15707","R-15708","R-15709","R-15710","R-15711","R-15712","R-15713","R-15714","R-15715","R-15716","R-15717","R-15718","R-15719","R-15720","R-15721","R-15765","R-16127"];
const btGroup3 = ["R-15651","R-15652","R-15653","R-15654","R-15655","R-15656","R-15657","R-15658","R-15659","R-15660","R-15661","R-15662","R-15663"];

/* ================= PROCESS ‚Üí HOURS ================= */
const processHourMap = {
  "Transit G2": { g1:16,g2:16,g3:15 },
  "Transit P-lane in G2": { g1:5,g2:5,g3:4.5 },
  "P-lane Out G2": { g1:6,g2:6,g3:5 },
  "Pre-Sort G2": { g1:5,g2:5,g3:4.5 },
  "Empty G2": { g1:5,g2:5,g3:4 },

  "Transit G3": { g1:16,g2:16,g3:15 },
  "Transit P-lane in G3": { g1:4.5,g2:4.5,g3:4 },
  "P-lane Out G3": { g1:5.5,g2:5.5,g3:5 },
  "Empty G3": { g1:5,g2:5,g3:4.5 }
};

/* ================= BREAK TIME ================= */
const breakTimes = [
  { start:"09:30",end:"09:40" },
  { start:"11:30",end:"12:30" },
  { start:"14:30",end:"14:40" },
  { start:"16:30",end:"17:00" },
  { start:"21:30",end:"21:40" },
  { start:"23:30",end:"00:30" },
  { start:"02:30",end:"02:40" },
  { start:"04:30",end:"05:00" }
];

/* ================= LIFF ================= */
let userId = "";

liff.init({ liffId: LIFF_ID }).then(() => {
  if (!liff.isLoggedIn()) {
    liff.login();
  } else {
    liff.getProfile().then(profile => {
      userId = profile.userId;
    });
  }
});

/* ================= UTIL ================= */
const pad = n => n.toString().padStart(2,"0");
const formatTime = d => `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
const formatDate = d => `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())}`;
const formatThaiDate = d => {
  const m = ["‡∏°.‡∏Ñ.","‡∏Å.‡∏û.","‡∏°‡∏µ.‡∏Ñ.","‡πÄ‡∏°.‡∏¢.","‡∏û.‡∏Ñ.","‡∏°‡∏¥.‡∏¢.","‡∏Å.‡∏Ñ.","‡∏™.‡∏Ñ.","‡∏Å.‡∏¢.","‡∏ï.‡∏Ñ.","‡∏û.‡∏¢.","‡∏ò.‡∏Ñ."];
  return `${d.getDate()} ${m[d.getMonth()]} ${d.getFullYear()+543}`;
};

function getSubmitDateTime(){ return new Date(); }

/* ================= LOGIC ================= */
function isBreakTime(date){
  const min = date.getHours()*60 + date.getMinutes();
  return breakTimes.some(b=>{
    const [sh,sm]=b.start.split(":").map(Number);
    const [eh,em]=b.end.split(":").map(Number);
    const s=sh*60+sm, e=eh*60+em;
    return s>e ? min>=s||min<e : min>=s&&min<e;
  });
}

function addWorkingHours(start,h){
  let cur=new Date(start), min=h*60;
  while(min>0){
    cur.setMinutes(cur.getMinutes()+1);
    if(!isBreakTime(cur)) min--;
  }
  return cur;
}

function getGroup(fl){
  if(flGroup1.includes(fl)) return "g1";
  if(flGroup2.includes(fl)) return "g2";
  if(flGroup3.includes(fl)) return "g3";
  return null;
}

function getChangeDateTime(submit){
  const p=processNo.value;
  const fl=flNumber.value;
  if(!p||!fl) return null;

  const g=getGroup(fl);
  const h=processHourMap[p]?.[g];
  if(!h) return null;

  return addWorkingHours(submit,h);
}

function updateBT(){
  const fl=flNumber.value;
  btNumber.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Battery --</option>';

  let list=[];
  if(flGroup1.includes(fl)) list=btGroup1;
  else if(flGroup2.includes(fl)) list=btGroup2;
  else if(flGroup3.includes(fl)) list=btGroup3;

  list.forEach(b=>{
    btNumber.innerHTML+=`<option value="${b}">${b}</option>`;
  });

  previewChangeTime();
}

function previewChangeTime(){
  const box=document.getElementById("changeDateTime");

  if(!processNo.value){ box.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process"; return; }
  if(!flNumber.value){ box.textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Forklift"; return; }

  const submit=getSubmitDateTime();
  const changeDate=getChangeDateTime(submit);
  if(!changeDate){ box.textContent="-"; return; }

  const group=getGroup(flNumber.value);
  const hours=processHourMap[processNo.value]?.[group];

  box.innerHTML=`
    üìÖ ${formatThaiDate(changeDate)}<br>
    ‚è∞ ${formatTime(changeDate)}<br>
    ‚è≥ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
  `;
}

/* ================= INIT FL ================= */
for(let i=1;i<=40;i++){
  const f=`FL-${String(i).padStart(2,"0")}`;
  flNumber.innerHTML+=`<option value="${f}">${f}</option>`;
}

/* ================= SUBMIT ================= */
function submitForm(){
  if(!processNo.value||!flNumber.value||!btNumber.value){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
    return;
  }

  const s=getSubmitDateTime();
  const c=getChangeDateTime(s);

  fetch(FLOW_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      userId:userId,
      processNo:processNo.value,
      flNumber:flNumber.value,
      btNumber:btNumber.value,
      DateSubmit:formatDate(s),
      TimeSubmit:formatTime(s),
      DateChange:formatDate(c),
      TimeChange:formatTime(c)
    })
  }).then(()=>{
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
    liff.closeWindow();
  });
}
</script>
