<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }

    h3 {
      text-align: center;
    }

    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }

    select,
    button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      font-size: 16px;
    }

    button {
      margin-top: 20px;
      background: #06c755;
      color: #fff;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>

<body>

  <h3>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>

  <label>Process No</label>
  <select id="processNo" onchange="previewChangeTime()">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process --</option>
    <option value="P-Lane In">P-Lane In</option>
    <option value="P-Lane Out">P-Lane Out</option>
    <option value="Transit">Transit</option>
    <option value="Pre-Sort">Pre-Sort</option>
    <option value="Empty">Empty</option>

  </select>


  <label>Forklift No</label>
  <select id="flNumber" onchange="updateBT()">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÇ‡∏ü‡∏•‡πå‡∏Ñ‡∏•‡∏¥‡∏ü‡∏ó‡πå --</option>
  </select>


  <label>Battery No</label>
  <select id="btNumber" onchange="previewChangeTime()">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà --</option>
  </select>

  <label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏ö‡∏ï‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
  <div id="changeDateTime" style="margin-top:6px;padding:12px;background:#fff;border-radius:6px;
              font-size:16px;color:#333;">
    ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process
  </div>

  <button onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

  <script>
    /* ================= CONFIG ================= */
    const LIFF_ID = "2008917250-2HZ9qo2C";
    const FLOW_URL = "https://defaultd9cd485e39bd4cc995398c97631fbb.71.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6195382cbe7940ccb47ec0b364f02c8b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LOAM7JCklNTPQbiVkRekzwQFxFiQ32bUtKrMf7Vb5Pc";

    /* ============ FL ‚Üí BT Mapping ============ */
    const btMap = {
      "FL-01": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-02": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],

      "FL-04": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-05": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-06": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-07": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-08": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-09": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-10": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-11": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],

      "FL-13": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-14": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-15": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-16": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-17": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-18": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-19": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-20": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-21": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-22": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-23": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-24": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],

      "FL-26": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],
      "FL-27": ["R-15707", "R-15708", "R-15709", "R-15710", "R-15711", "R-15712", "R-15713", "R-15714", "R-15715", "R-15716", "R-15717", "R-15718", "R-15719", "R-15720", "R-15721", "R-15765", "R-16127"],

      "FL-29": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-30": ["R-15686", "R-15687", "R-15688", "R-15689", "R-15690", "R-15691", "R-15692", "R-15693"],
      "FL-32": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-33": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-34": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-35": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-36": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-37": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"],
      "FL-38": ["R-15651", "R-15652", "R-15653", "R-15654", "R-15655", "R-15656", "R-15657", "R-15658", "R-15659", "R-15660", "R-15661", "R-15662", "R-15663"]

    };

    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ‡∏õ‡∏£‡∏Å‡∏ï‡∏¥
    const breakTimes = [
      // ‡∏Å‡∏∞‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô
      { start: "09:30", end: "09:40" },
      { start: "11:30", end: "12:30" },
      { start: "14:30", end: "14:40" },
      { start: "16:30", end: "17:00" },

      // ‡∏Å‡∏∞‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô
      { start: "21:30", end: "21:40" },
      { start: "23:30", end: "00:30" },
      { start: "02:30", end: "02:40" },
      { start: "04:30", end: "05:00" }
    ];

    /* ================= LIFF INIT ================= */
    liff.init({ liffId: LIFF_ID }).then(() => {
      if (!liff.isLoggedIn()) {
        liff.login();
      }
    });

    /* ============ Utility Date/Time ============ */
    function pad(num) {
      return num.toString().padStart(2, '0');
    }

    /* ============ Change Format Date ============ */
    function formatDate(d) {
      return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())}`;
    }

    /* ============ Change Format Time ============ */
    function formatTime(d) {
      return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function formatThaiDate(d) {
      const months = [
        "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô",
        "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°",
        "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
      ];

      const day = d.getDate();
      const month = months[d.getMonth()];
      const year = d.getFullYear() + 543;

      return `${day} ${month} ${year}`;
    }

    function getSubmitDateTime() {
      return new Date(); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    }

    /* ============ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Preview ‡πÄ‡∏ß‡∏•‡∏≤ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Process) ============ */
    function previewChangeTime() {
      const display = document.getElementById("changeDateTime");

      if (!processNo.value) {
        display.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process";
        return;
      }

      const submitDate = getSubmitDateTime();
      const changeDate = getChangeDateTime(submitDate);

      if (!changeDate) {
        display.textContent = "-";
        return;
      }

      display.innerHTML = `
    üìÖ ${formatThaiDate(changeDate)}
    <br>
    ‚è∞ ${formatTime(changeDate)}
  `;
    }

    /* ============ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ ============ */
    function isBreakTime(date) {
      const minutes = date.getHours() * 60 + date.getMinutes();

      return breakTimes.some(b => {
        const [sh, sm] = b.start.split(":").map(Number);
        const [eh, em] = b.end.split(":").map(Number);

        const startMin = sh * 60 + sm;
        const endMin = eh * 60 + em;

        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô (‡πÄ‡∏ä‡πà‡∏ô 23:30 - 00:30)
        if (startMin > endMin) {
          return minutes >= startMin || minutes < endMin;
        }

        return minutes >= startMin && minutes < endMin;
      });
    }

    /* ============ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏ß‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å‡πÄ‡∏ö‡∏£‡∏Ñ ============ */
    function addWorkingHours(startDate, hoursToAdd) {
      let current = new Date(startDate);
      let minutesLeft = hoursToAdd * 60;

      while (minutesLeft > 0) {
        current.setMinutes(current.getMinutes() + 1);

        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å ‚Üí ‡∏ô‡∏±‡∏ö
        if (!isBreakTime(current)) {
          minutesLeft--;
        }
      }

      return current;
    }

    /* ============ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Bat ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ============ */
    function getChangeDateTime(submitDate) {
      const processNo = document.getElementById("processNo").value;

      if (!processNo) return null;

      let addHours = 0;

      switch (processNo) {
        case "Transit":
          addHours = 16;
          break;

        case "P-lane in":
          addHours = 4;
          break;

        case "P-lane Out":
          addHours = 6;
          break;

        case "Pre-Sort":
          addHours = 5;
          break;

        case "Empty":
          addHours = 5;
          break;

        default:
          addHours = 0;
      }

      return addWorkingHours(submitDate, addHours);
    }


    const select = document.getElementById("flNumber");
    for (let i = 1; i <= 40; i++) {
      const fl = `FL-${String(i).padStart(2, "0")}`;
      select.innerHTML += `<option value="${fl}">${fl}</option>`;
    }

    /* ============ Update BT Dropdown ============ */
    function updateBT() {
      const fl = document.getElementById("flNumber").value;
      const btSelect = document.getElementById("btNumber");

      btSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà --</option>';

      if (btMap[fl]) {
        btMap[fl].forEach(bt => {
          const opt = document.createElement("option");
          opt.value = bt;
          opt.textContent = bt;
          btSelect.appendChild(opt);
        });
      }

      previewChangeTime();
    }


    /* ================= Submit ================= */
    function submitForm() {

      if (!processNo.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Process No");
        return;
      }
      if (!flNumber.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Forklift No");
        return;
      }
      if (!btNumber.value) {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Battery No");
        return;
      }

      const submitDate = getSubmitDateTime();
      const changeDate = getChangeDateTime(submitDate);

      const data = {
        userId: liff.getContext().userId,
        processNo: processNo.value,
        flNumber: flNumber.value,
        btNumber: btNumber.value,

        DateSubmit: formatDate(submitDate),
        TimeSubmit: formatTime(submitDate),

        DateChange: formatDate(changeDate),
        TimeChange: formatTime(changeDate)
      };

      fetch(FLOW_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      }).then(() => {
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        liff.closeWindow();
      });
    }

  </script>

</body>

</html>
