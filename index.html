<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>เพิ่มข้อมูล</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 16px;
      background: #f5f5f5;
    }
    h3 {
      text-align: center;
    }
    label {
      display: block;
      margin-top: 12px;
      font-weight: bold;
    }
    select, button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      font-size: 16px;
    }
    button {
      margin-top: 20px;
      background: #06c755;
      color: #fff;
      border: none;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<h3>เพิ่มข้อมูล</h3>

<label>Process No</label>
<select id="processNo">
  <option value="">-- เลือก Process --</option>
  <option value="G2 P-Lane In">G2 P-Lane In</option>
  <option value="G2 P-Lane Out">G2 P-Lane Out</option>
  <option value="G2 Transit">G2 Transit</option>
  <option value="G3 P-Lane In">G3 P-Lane In</option>
  <option value="G3 P-Lane Out">G3 P-Lane Out</option>
  <option value="G3 Transit">G3 Transit</option>
</select>

<label>Forklift No</label>
<select id="flNumber" onchange="updateBT()">
  <option value="">-- เลือก โฟล์คลิฟท์ --</option>
  <option value="FL-01">FL-01</option>
  <option value="FL-02">FL-02</option>
  <option value="FL-03">FL-03</option>
</select>

<label>Battery No</label>
<select id="btNumber">
  <option value="">-- เลือก แบตเตอรี่ --</option>
</select>

<button onclick="submitForm()">บันทึกข้อมูล</button>

<script>
  /* ================= CONFIG ================= */
  const LIFF_ID = "2008917250-2HZ9qo2C";
  const FLOW_URL = "https://defaultd9cd485e39bd4cc995398c97631fbb.71.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6195382cbe7940ccb47ec0b364f02c8b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=LOAM7JCklNTPQbiVkRekzwQFxFiQ32bUtKrMf7Vb5Pc";

  /* ============ FL → BT Mapping ============ */
  const btMap = {
    "FL-01": [
      "R-15686","R-15687","R-15688","R-15689",
      "R-15690","R-15691","R-15692","R-15693"
    ],
    "FL-02": [
      "R-15707","R-15708","R-15709","R-15710","R-15711",
      "R-15712","R-15713","R-15714","R-15715","R-15716",
      "R-15717","R-15718","R-15719","R-15720","R-15721",
      "R-15765","R-16127"
    ],
    "FL-03": [
      "R-15651","R-15652","R-15653","R-15654","R-15655",
      "R-15656","R-15657","R-15658","R-15659","R-15660",
      "R-15661","R-15662","R-15663"
    ]
  };

  /* ================= LIFF INIT ================= */
  liff.init({ liffId: LIFF_ID }).then(() => {
    if (!liff.isLoggedIn()) {
      liff.login();
    }
  });

  /* ============ Utility Date/Time ============ */
  function pad(num) {
    return num.toString().padStart(2, '0');
  }

  function formatDate(d) {
    return `${d.getFullYear()}/${pad(d.getMonth() + 1)}/${pad(d.getDate())}`;
  }

  function formatTime(d) {
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function getSubmitDateTime() {
    return new Date(); // เวลาปัจจุบัน
  }

  function getChangeDateTime(submitDate) {
    return new Date(submitDate.getTime() + (4 * 60 * 60 * 1000)); // +4 ชั่วโมง
  }

  /* ============ Update BT Dropdown ============ */
  function updateBT() {
    const fl = document.getElementById("flNumber").value;
    const btSelect = document.getElementById("btNumber");

    btSelect.innerHTML = '<option value="">-- เลือก แบตเตอรี่ --</option>';

    if (btMap[fl]) {
      btMap[fl].forEach(bt => {
        const opt = document.createElement("option");
        opt.value = bt;
        opt.textContent = bt;
        btSelect.appendChild(opt);
      });
    }
  }

  /* ================= Submit ================= */
  function submitForm() {

    const submitDate = getSubmitDateTime();
    const changeDate = getChangeDateTime(submitDate);

    const data = {
      userId: liff.getContext().userId,
      processNo: processNo.value,
      flNumber: flNumber.value,
      btNumber: btNumber.value,

      DateSubmit: formatDate(submitDate),
      TimeSubmit: formatTime(submitDate),

      DateChange: formatDate(changeDate),
      TimeChange: formatTime(changeDate)
    };

    if (!data.processNo || !data.flNumber || !data.btNumber) {
      alert("กรุณาเลือกข้อมูลให้ครบ");
      return;
    }

    fetch(FLOW_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    }).then(() => {
      alert("บันทึกข้อมูลเรียบร้อย");
      liff.closeWindow();
    });
  }
</script>

</body>
</html>
